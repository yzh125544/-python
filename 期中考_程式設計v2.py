# -*- coding: utf-8 -*-
"""æœŸä¸­è€ƒ-ç¨‹å¼è¨­è¨ˆ

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1RV1OyeTJ03v_za_HZX-9j5owZ_mGVHSt
"""

# ==============================================================================
# 2025 å…¨åœ‹å¤å­£å­¸é™¢ åˆç´šç¨‹å¼è¨­è¨ˆ-Python-æœŸä¸­è€ƒ
# ==============================================================================
# è‘‰æ”¿å®
# ==============================================================================
# Cell 1: ç’°å¢ƒè¨­å®šèˆ‡å¥—ä»¶å®‰è£
# ==============================================================================
print("æ­£åœ¨å®‰è£å¿…è¦çš„å¥—ä»¶...")
print("âœ…å¥—ä»¶å®‰è£å®Œæˆã€‚")

import warnings
import logging
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.font_manager import FontProperties, findfont, _load_fontmanager
import matplotlib.gridspec as gridspec
import matplotlib.patches as mpatches
import seaborn as sns
import requests
import json
from datetime import datetime, timedelta
import time
import io
import os
from IPython.display import display, Markdown, clear_output
import ipywidgets as widgets
from tabulate import tabulate
from google.colab import userdata
from google.colab.userdata import SecretNotFoundError
import numpy as np
from scipy import stats

# ==============================================================================
# Cell 2: ç¹é«”ä¸­æ–‡è¨­å®š
# ==============================================================================
print("\nğŸ”„ æ­£åœ¨è¨­å®š Matplotlib ç¹é«”ä¸­æ–‡ç’°å¢ƒ...")
warnings.filterwarnings('ignore')
logging.getLogger('matplotlib').setLevel(logging.ERROR)

font_path = '/usr/share/fonts/truetype/NotoSansCJKtc-Regular.otf'

try:
    if not os.path.exists(font_path):
        print("   - ä¸­æ–‡å­—é«”æœªæ‰¾åˆ°ï¼Œæ­£åœ¨å¾ç¶²è·¯ä¸‹è¼‰...")
        get_ipython().system(f'wget -q https://noto-website-2.storage.googleapis.com/pkgs/NotoSansCJKtc-hinted.zip && unzip -oq -p NotoSansCJKtc-hinted.zip NotoSansCJKtc-Regular.otf > {font_path} && rm NotoSansCJKtc-hinted.zip')
        _load_fontmanager(try_read_cache=False)
        print(f"   - å­—é«”å·²å®‰è£ä¸¦åˆ·æ–°å¿«å–ã€‚")
    else:
        print(f"   - åµæ¸¬åˆ°å·²å®‰è£çš„å­—é«”ã€‚")

    zh_font = FontProperties(fname=font_path, size=12)
    if findfont(zh_font) == font_path:
         print("\nâœ… Matplotlib ç¹é«”ä¸­æ–‡è¨­å®šå®Œæˆ")
    else:
        raise RuntimeError("Matplotlib æœªèƒ½æˆåŠŸè¼‰å…¥ä¸­æ–‡å­—é«”ï¼Œè«‹å˜—è©¦é‡å•ŸåŸ·è¡Œç’°å¢ƒã€‚")

except Exception as e:
    print(f"âŒ å­—é«”è¨­å®šå¤±æ•—: {e}")
    print("   è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ– Colab ç’°å¢ƒæ¬Šé™ã€‚")

# ==============================================================================
# Cell 3: ä¸»è¦ç¨‹å¼
# ==============================================================================

class DataHandler:
    """
    è² è²¬å¾ç’°å¢ƒéƒ¨é–‹æ”¾è³‡æ–™å¹³å°ç²å–ã€æ¸…ç†åŠæ•´åˆç©ºæ°£å“è³ªè³‡æ–™ã€‚
    """
    def __init__(self, api_key: str):
        if not api_key:
            raise ValueError("è«‹æä¾›æœ‰æ•ˆçš„ API é‡‘é‘°")
        self.api_key = api_key
        self.request_delay = 0.5
        self.max_retries = 3
        self.headers = {
            'User-Agent': ('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36')
        }

    def fetch_data_for_range(self, start_date_str: str, end_date_str: str) -> pd.DataFrame:
        """
        ä½¿ç”¨å‰ä¸€å¤©23:59:59ä½œç‚ºèµ·å§‹é»ï¼Œç¢ºä¿åŒ…å«01/01è³‡æ–™
        """
        print(f" {'â•'*15} é–‹å§‹æŠ“å–è³‡æ–™ {'â•'*15} ")
        print(f"   - ç›®æ¨™å€é–“: {start_date_str} è‡³ {end_date_str}")

        all_records = []
        offset = 0
        limit = 1000

        # è¨ˆç®—å‰ä¸€å¤©çš„23:59:59ä½œç‚ºèµ·å§‹æ¢ä»¶
        start_date_obj = datetime.strptime(start_date_str, '%Y-%m-%d').date()
        prev_day = start_date_obj - timedelta(days=1)
        prev_day_str = prev_day.strftime('%Y-%m-%d')

        # è¨­å®šç¯©é¸æ¢ä»¶
        start_condition = f"{prev_day_str} 23:59:59"  # å‰ä¸€å¤©çš„23:59:59
        end_condition = f"{end_date_str} 23:59:59"     # çµæŸæ—¥æœŸçš„23:59:59

        print(f"   - ç¯©é¸æ¢ä»¶: GT {start_condition} ä¸” LE {end_condition}")
        print(f"   - é‚è¼¯èªªæ˜: å¤§æ–¼ {start_condition}ï¼Œå°æ–¼ç­‰æ–¼ {end_condition}")

        while True:
            print(f"\rğŸ”„ æ­£åœ¨ä¸‹è¼‰è³‡æ–™ï¼Œç›®å‰å·²ç²å– {len(all_records):,} ç­†...", end="")
            url = "https://data.moenv.gov.tw/api/v2/aqx_p_488"
            params = {
                'format': 'json',
                'offset': offset,
                'limit': limit,
                'api_key': self.api_key,
                'filters': f'datacreationdate,GT,{start_condition}|datacreationdate,LE,{end_condition}',
                'sort': 'datacreationdate asc'
            }

            for attempt in range(self.max_retries + 1):
                try:
                    response = requests.get(url, params=params, headers=self.headers, timeout=60)
                    if response.status_code == 200:
                        batch_data = response.json()
                        records = batch_data.get('records', [])

                        if not records:
                            if offset == 0:
                                print("\nâš ï¸ åœ¨æŒ‡å®šå€é–“å…§æœªæ‰¾åˆ°ä»»ä½•è³‡æ–™ã€‚")
                                return pd.DataFrame()
                            else:
                                print(f"\nâœ… è³‡æ–™ä¸‹è¼‰å®Œæˆï¼")
                                return pd.DataFrame(all_records)

                        all_records.extend(records)

                        if len(records) < limit:
                            print(f"\nâœ… è³‡æ–™ä¸‹è¼‰å®Œæˆï¼")
                            return pd.DataFrame(all_records)

                        offset += limit
                        time.sleep(self.request_delay)
                        break
                    else:
                        raise requests.exceptions.HTTPError(f"ç‹€æ…‹ç¢¼: {response.status_code}")
                except Exception as e:
                    if attempt < self.max_retries:
                        print(f"\n...ä¸‹è¼‰å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦ ({attempt+1}/{self.max_retries})...")
                        time.sleep(2 ** attempt)
                    else:
                        print(f"\nâŒ ä¸‹è¼‰å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸: {e}")
                        return pd.DataFrame(all_records)
        return pd.DataFrame(all_records)

    def clean_data(self, df: pd.DataFrame) -> (pd.DataFrame, dict):
        if df.empty:
            return pd.DataFrame(), {}

        print("\nğŸ§¹ æ­£åœ¨é€²è¡Œè³‡æ–™æ¸…ç†èˆ‡é©—è­‰...")
        raw_count = len(df)
        print(f"   - æ¸…ç†å‰åŸå§‹è³‡æ–™å…±: {raw_count:,} ç­†ã€‚")

        df['datacreationdate'] = pd.to_datetime(df['datacreationdate'])

        if not df.empty:
            min_date = df['datacreationdate'].min()
            max_date = df['datacreationdate'].max()
            print(f"   - å¯¦éš›è³‡æ–™æ™‚é–“ç¯„åœ: {min_date} è‡³ {max_date}")

            target_start = pd.to_datetime("2025-01-01 00:00:00")
            target_end = pd.to_datetime("2025-03-31 23:59:59")

            original_count = len(df)
            df = df[
                (df['datacreationdate'] >= target_start) &
                (df['datacreationdate'] <= target_end)
            ]
            filtered_count = len(df)

            if original_count != filtered_count:
                removed_out_of_range = original_count - filtered_count
                print(f"   âœ… æˆåŠŸç§»é™¤ {removed_out_of_range} ç­†è¶…å‡ºç¯„åœçš„è³‡æ–™")

            jan_first_morning = df[
                (df['datacreationdate'].dt.date == pd.to_datetime('2025-01-01').date()) &
                (df['datacreationdate'].dt.hour >= 0) &
                (df['datacreationdate'].dt.hour < 2)
            ]

            if not jan_first_morning.empty:
                print(f"âœ… æˆåŠŸä¿ç•™ 2025-01-01 00:00-02:00 æ™‚æ®µè³‡æ–™: {len(jan_first_morning)} ç­†ï¼ˆé©—è­‰æ˜¯å¦æœ‰éºæ¼00:00æ™‚æ®µçš„è³‡æ–™ï¼‰")
                print(f"   - æœ€æ—©è³‡æ–™æ™‚é–“: {jan_first_morning['datacreationdate'].min()}")
            else:
                print(f"   âš ï¸ æœªæ‰¾åˆ° 2025-01-01 00:00æ™‚æ®µè³‡æ–™")

        numeric_cols = ['aqi', 'pm2.5', 'pm10', 'o3', 'so2', 'co', 'no2']
        for col in numeric_cols:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')

        valid_rows = df['aqi'].notna() & df['county'].notna() & df['pm2.5'].notna()
        df_filtered = df[valid_rows].copy()

        cleaned_count = len(df_filtered)
        removed_count = raw_count - cleaned_count

        print(f"   - æœ€çµ‚ä¿ç•™è³‡æ–™å…±: {cleaned_count:,} ç­†ã€‚")
        if removed_count > 0:
            print(f"   - (ç§»é™¤äº† {removed_count:,} ç­†ç„¡æ•ˆè³‡æ–™)")

        if not df_filtered.empty:
            df_filtered['aqi'] = df_filtered['aqi'].astype(int)
            df_filtered['hour'] = df_filtered['datacreationdate'].dt.hour
            df_filtered['date'] = df_filtered['datacreationdate'].dt.date

        print("âœ… è³‡æ–™æ¸…ç†èˆ‡é©—è­‰å®Œæˆã€‚")

        cleaning_stats = {
            "raw": raw_count,
            "cleaned": cleaned_count,
            "removed": removed_count
        }
        return df_filtered, cleaning_stats

class AQIVisualizer:
    def __init__(self, df: pd.DataFrame, cleaning_stats: dict, font_path: str):
        if df.empty:
            raise ValueError("è¦–è¦ºåŒ–å·¥å…·ç„¡æ³•è™•ç†ç©ºçš„ DataFrameã€‚")
        self.full_df = df
        self.cleaning_stats = cleaning_stats
        self.font_prop = FontProperties(fname=font_path, size=12)
        self.font_prop_large = FontProperties(fname=font_path, size=14)
        self.font_prop_text = FontProperties(fname=font_path, size=14)
        self.font_prop_title = FontProperties(fname=font_path, size=24)
        self.font_prop_suptitle = FontProperties(fname=font_path, size=32)

        self.aqi_colors = {
            'è‰¯å¥½': '#00e400', 'æ™®é€š': '#ffff00', 'å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·': '#ff7e00',
            'ä¸å¥åº·': '#ff0000', 'éå¸¸ä¸å¥åº·': '#99004c', 'å±å®³': '#7e0023'
        }
        self.category_order = list(self.aqi_colors.keys())

        sns.set_theme(style="whitegrid", font=self.font_prop.get_name())
        plt.rcParams['axes.unicode_minus'] = False

    def _categorize_aqi(self, aqi: int):
        if aqi <= 50: return 'è‰¯å¥½'
        if aqi <= 100: return 'æ™®é€š'
        if aqi <= 150: return 'å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·'
        if aqi <= 200: return 'ä¸å¥åº·'
        if aqi <= 300: return 'éå¸¸ä¸å¥åº·'
        return 'å±å®³'

    def display_interactive_dashboard(self):
        sites = ['å…¨å°å¹³å‡'] + sorted(self.full_df['sitename'].unique())
        site_select = widgets.Dropdown(options=sites, value='å…¨å°å¹³å‡', description='é¸æ“‡æ¸¬ç«™:')
        return_button = widgets.Button(description="è¿”å›å…¨å°è¦–åœ–", button_style='info', layout=widgets.Layout(margin='0 0 0 10px'))
        controls = widgets.HBox([site_select, return_button])
        output = widgets.Output()

        def _update_dashboard(change):
            selected_site = change['new']
            with output:
                clear_output(wait=True)
                print(f"ğŸ”„ æ­£åœ¨ç‚ºã€Œ{selected_site}ã€ç”Ÿæˆåœ–è¡¨...")
                time.sleep(0.5)
                try:
                    display_df = self.full_df if selected_site == 'å…¨å°å¹³å‡' else self.full_df[self.full_df['sitename'] == selected_site]
                    self._plot_dashboard(display_df, selected_site)
                except Exception as e:
                    print(f"âŒ è™•ç† {selected_site} æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

        def on_return_button_clicked(b):
            site_select.value = 'å…¨å°å¹³å‡'

        site_select.observe(_update_dashboard, names='value')
        return_button.on_click(on_return_button_clicked)

        print("\n ========== ç©ºæ°£å“è³ªåˆ†æ ========== ")
        display(controls, output)
        _update_dashboard({'new': 'å…¨å°å¹³å‡'})

    def _plot_dashboard(self, df: pd.DataFrame, title_site: str):
        if df.empty:
            print(f"âŒ {title_site} åœ¨æ­¤æœŸé–“å…§ç„¡æœ‰æ•ˆ AQI è³‡æ–™ã€‚")
            return

        plt.close('all')
        fig = plt.figure(figsize=(20, 65))
        gs = gridspec.GridSpec(7, 2, figure=fig, height_ratios=[0.8, 1, 1.2, 1.2, 1.2, 1.2, 0.2])
        fig.suptitle(f'ç©ºæ°£å“è³ªåˆ†æåœ– - {title_site}', fontproperties=self.font_prop_suptitle, y=0.99)

        ax_cleaning = fig.add_subplot(gs[0, :])
        ax_table_high = fig.add_subplot(gs[1, 0])
        ax_table_low = fig.add_subplot(gs[1, 1])
        ax_trend = fig.add_subplot(gs[2, :])
        ax_pm25_weekly = fig.add_subplot(gs[3, 0])
        ax_county_ratio = fig.add_subplot(gs[3, 1])
        ax_county_pm25 = fig.add_subplot(gs[4, :])
        ax_enhanced_scatter = fig.add_subplot(gs[5, 0])
        ax_cat_bar = fig.add_subplot(gs[5, 1])
        ax_legend = fig.add_subplot(gs[6, :])

        self._plot_data_cleaning_summary(ax_cleaning, title_site)

        self._plot_table(ax_table_high, 'AQI æœ€é«˜å‰ 10 æ¸¬ç«™', ascending=False, title_site=title_site)
        self._plot_table(ax_table_low, 'AQI æœ€ä½å‰ 10 æ¸¬ç«™', ascending=True, title_site=title_site)

        ax_trend.set_title('AQI è¶¨å‹¢èˆ‡ 24 å°æ™‚ç§»å‹•å¹³å‡åœ–', fontproperties=self.font_prop_title)
        hourly_avg = df.set_index('datacreationdate').resample('h')['aqi'].mean().dropna()

        ax_trend.axhspan(0, 50, facecolor=self.aqi_colors['è‰¯å¥½'], alpha=0.3, zorder=0)
        ax_trend.axhspan(51, 100, facecolor=self.aqi_colors['æ™®é€š'], alpha=0.3, zorder=0)
        ax_trend.axhspan(101, 150, facecolor=self.aqi_colors['å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·'], alpha=0.3, zorder=0)
        ax_trend.axhspan(151, 200, facecolor=self.aqi_colors['ä¸å¥åº·'], alpha=0.3, zorder=0)

        ax_trend.scatter(hourly_avg.index, hourly_avg.values, label='æ¯å°æ™‚å¹³å‡ AQI', color='dimgray', alpha=0.5, s=20, zorder=2)
        moving_avg = hourly_avg.rolling(window=24, min_periods=1).mean()
        ax_trend.plot(moving_avg.index, moving_avg.values, label='24å°æ™‚ç§»å‹•å¹³å‡', color='royalblue', linewidth=3, zorder=3)

        ax_trend.set_xlabel('æ—¥æœŸæ™‚é–“', fontproperties=self.font_prop_large)
        ax_trend.set_ylabel('AQI æŒ‡æ•¸', fontproperties=self.font_prop_large)
        ax_trend.legend(prop=self.font_prop_large)
        ax_trend.grid(True, which='both', linestyle='--', linewidth=0.5)

        self._plot_pm25_weekly(ax_pm25_weekly, df, title_site)

        self._plot_county_aqi_ratio(ax_county_ratio, df, title_site)

        self._plot_county_pm25_comparison(ax_county_pm25, df, title_site)

        self._plot_enhanced_aqi_pm25_scatter(ax_enhanced_scatter, df, title_site)

        ax_cat_bar.set_title('AQI åˆ†ç´šä½”æ¯”åœ–', fontproperties=self.font_prop_title)
        df_cat_bar = df.copy()
        df_cat_bar['aqi_category'] = pd.Categorical(df_cat_bar['aqi'].apply(self._categorize_aqi), categories=self.category_order, ordered=True)
        aqi_dist_pct = df_cat_bar['aqi_category'].value_counts(normalize=True).mul(100).sort_index()
        if not aqi_dist_pct.empty:
            bar_colors = [self.aqi_colors.get(cat) for cat in aqi_dist_pct.index]
            bars = ax_cat_bar.barh(aqi_dist_pct.index, aqi_dist_pct.values, color=bar_colors, edgecolor='black', linewidth=0.5)
            ax_cat_bar.set_xlabel('ç™¾åˆ†æ¯” (%)', fontproperties=self.font_prop_large)
            for bar in bars:
                ax_cat_bar.text(bar.get_width() + 0.5, bar.get_y() + bar.get_height()/2, f'{bar.get_width():.1f}%',
                                va='center', ha='left', fontproperties=self.font_prop_large)
        else:
            ax_cat_bar.text(0.5, 0.5, 'ç„¡æœ‰æ•ˆåˆ†ç´šè³‡æ–™', ha='center', va='center', fontproperties=self.font_prop_text)

        self._plot_color_legend(ax_legend)

        for ax in fig.get_axes():
            if ax not in [ax_table_high, ax_table_low, ax_legend]:
                for label in ax.get_xticklabels() + ax.get_yticklabels():
                    label.set_fontproperties(self.font_prop_large)

        plt.tight_layout(rect=[0, 0, 1, 0.97], h_pad=6, w_pad=4)
        plt.show()

    def _plot_table(self, ax, title, ascending, title_site):
        ax.set_title(title, fontproperties=self.font_prop_title)
        ax.axis('off')
        if title_site == 'å…¨å°å¹³å‡':
            site_data = self.full_df.groupby(['sitename', 'county'])['aqi'].mean().sort_values(ascending=ascending).head(10).reset_index()
            site_data['aqi'] = site_data['aqi'].round(1)
            site_data['æ¸¬ç«™'] = site_data.apply(lambda row: f"{row['sitename']} ({row['county']})", axis=1)
            table_data = site_data[['æ¸¬ç«™', 'aqi']]
            table_data.columns = ['æ¸¬ç«™', 'å¹³å‡ AQI']

            table = ax.table(cellText=table_data.values, colLabels=table_data.columns, loc='center', cellLoc='center')
            table.auto_set_font_size(False)
            table.set_fontsize(14)
            for (row, col), cell in table.get_celld().items():
                cell.set_text_props(fontproperties=self.font_prop_large)
                if row == 0:
                    cell.set_text_props(fontproperties=self.font_prop_large, weight='bold')
                    cell.set_facecolor('#f0f0f0')
            table.scale(1, 2.5)
        else:
            ax.text(0.5, 0.5, 'æ­¤è¡¨æ ¼åƒ…åœ¨ã€Œå…¨å°å¹³å‡ã€ç¯„åœä¸‹é¡¯ç¤º', ha='center', va='center', fontproperties=self.font_prop_text)

    def _plot_color_legend(self, ax):
        ax.set_title("AQI ç­‰ç´šé¡è‰²æ¨™æº–", fontproperties=self.font_prop_title)
        patches = [mpatches.Patch(color=color, label=label) for label, color in self.aqi_colors.items()]
        ax.legend(handles=patches, ncol=6, prop=self.font_prop_large, loc='center', frameon=False)
        ax.set_axis_off()

    def _plot_data_cleaning_summary(self, ax, title_site):
        ax.set_title("æ•¸æ“šæ¸…ç†æ‘˜è¦åœ–", fontproperties=self.font_prop_title)
        if title_site == 'å…¨å°å¹³å‡':
            labels = [f"åŸå§‹è³‡æ–™\n({self.cleaning_stats['raw']:,} ç­†)",
                      f"ç§»é™¤ç„¡æ•ˆè³‡æ–™\n({self.cleaning_stats['removed']:,} ç­†)",
                      f"æœ€çµ‚æœ‰æ•ˆè³‡æ–™\n({self.cleaning_stats['cleaned']:,} ç­†)"]
            counts = [self.cleaning_stats['raw'], self.cleaning_stats['removed'], self.cleaning_stats['cleaned']]
            colors = ['skyblue', 'salmon', 'lightgreen']

            bars = ax.bar(labels, counts, color=colors, width=0.6)
            ax.set_ylabel("è³‡æ–™ç­†æ•¸", fontproperties=self.font_prop_large)
            ax.tick_params(axis='x', labelsize=14)
            ax.get_yaxis().set_major_formatter(plt.FuncFormatter(lambda x, loc: "{:,}".format(int(x))))

            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width()/2.0, height, f'{height:,}', ha='center', va='bottom', fontproperties=self.font_prop_large)

            ax.spines['top'].set_visible(False)
            ax.spines['right'].set_visible(False)
        else:
            ax.text(0.5, 0.5, 'æ­¤åœ–è¡¨åƒ…åœ¨ã€Œå…¨å°å¹³å‡ã€è¦–åœ–ä¸‹é¡¯ç¤º', ha='center', va='center', fontproperties=self.font_prop_text)

    def _plot_pm25_weekly(self, ax, df, title_site):
        """ç¹ªè£½PM2.5æ¯é€±é•·æ¢åœ–"""
        ax.set_title('PM2.5æ¯é€±å¹³å‡æ¿ƒåº¦åœ–', fontproperties=self.font_prop_title)

        if not df.empty:
            df_weekly = df.copy()
            df_weekly['week'] = df_weekly['datacreationdate'].dt.isocalendar().week

            weekly_pm25 = df_weekly.groupby('week')['pm2.5'].mean()

            bars = ax.bar(weekly_pm25.index, weekly_pm25.values, color='steelblue', edgecolor='black', linewidth=0.5)
            ax.set_xlabel('é€±æ¬¡', fontproperties=self.font_prop_large)
            ax.set_ylabel('PM2.5 å¹³å‡æ¿ƒåº¦ (Î¼g/mÂ³)', fontproperties=self.font_prop_large)

            for bar in bars:
                ax.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.5,
                       f'{bar.get_height():.1f}', ha='center', va='bottom', fontproperties=self.font_prop_large)
        else:
            ax.text(0.5, 0.5, 'ç„¡æœ‰æ•ˆPM2.5è³‡æ–™', ha='center', va='center', fontproperties=self.font_prop_text)

    def _plot_county_aqi_ratio(self, ax, df, title_site):
        """ç¹ªè£½å„ç¸£å¸‚åˆ†ç´šAQIæ¯”ä¾‹åœ–"""
        ax.set_title('å„ç¸£å¸‚AQIåˆ†ç´šæ¯”ä¾‹åˆ†å¸ƒåœ–', fontproperties=self.font_prop_title)

        if title_site == 'å…¨å°å¹³å‡' and not df.empty:
            df_ratio = df.copy()
            df_ratio['aqi_category'] = df_ratio['aqi'].apply(self._categorize_aqi)

            county_aqi_dist = df_ratio.groupby(['county', 'aqi_category']).size().unstack(fill_value=0)
            county_aqi_ratio = county_aqi_dist.div(county_aqi_dist.sum(axis=1), axis=0) * 100

            county_aqi_ratio.plot(kind='barh', stacked=True, ax=ax,
                                color=[self.aqi_colors.get(cat, 'gray') for cat in county_aqi_ratio.columns],
                                width=0.8)
            ax.set_xlabel('ç™¾åˆ†æ¯” (%)', fontproperties=self.font_prop_large)
            ax.set_ylabel('ç¸£å¸‚', fontproperties=self.font_prop_large)

            legend = ax.legend(title='AQIåˆ†ç´š', prop=self.font_prop, bbox_to_anchor=(1.05, 1), loc='upper left')
            legend.get_title().set_fontproperties(self.font_prop)

            for label in ax.get_yticklabels():
                label.set_fontproperties(self.font_prop_large)

            for label in ax.get_xticklabels():
                label.set_fontproperties(self.font_prop_large)

        else:
            ax.text(0.5, 0.5, 'æ­¤åœ–è¡¨åƒ…åœ¨ã€Œå…¨å°å¹³å‡ã€è¦–åœ–ä¸‹é¡¯ç¤º', ha='center', va='center', fontproperties=self.font_prop_text)

    def _plot_county_pm25_comparison(self, ax, df, title_site):
        """ç¹ªè£½å„ç¸£å¸‚å¹³å‡PM2.5æ¯”è¼ƒé•·æ¢åœ–"""
        ax.set_title('å„ç¸£å¸‚å¹³å‡PM2.5æ¿ƒåº¦æ¯”è¼ƒåœ–ï¼ˆç©ºæ°£å“è³ªæ’åï¼‰', fontproperties=self.font_prop_title)

        if title_site == 'å…¨å°å¹³å‡' and not df.empty:
            county_pm25_avg = df.groupby('county')['pm2.5'].mean().sort_values()
            colors = ['green' if x <= 15 else 'orange' if x <= 35 else 'red' for x in county_pm25_avg.values]

            bars = ax.bar(range(len(county_pm25_avg)), county_pm25_avg.values,
                         color=colors, edgecolor='black', linewidth=0.5)
            ax.set_xticks(range(len(county_pm25_avg)))
            ax.set_xticklabels(county_pm25_avg.index, rotation=45, ha='right')
            ax.set_ylabel('PM2.5 å¹³å‡æ¿ƒåº¦ (Î¼g/mÂ³)', fontproperties=self.font_prop_large)

            for i, bar in enumerate(bars):
                ax.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.5,
                       f'{county_pm25_avg.values[i]:.1f}', ha='center', va='bottom',
                       fontproperties=self.font_prop_large)
            ax.axhline(y=15, color='green', linestyle='--', alpha=0.7, label='è‰¯å¥½æ¨™æº–')
            ax.axhline(y=35, color='orange', linestyle='--', alpha=0.7, label='æ™®é€šæ¨™æº–')
            ax.legend(prop=self.font_prop)
            best_county = county_pm25_avg.index[0]
            worst_county = county_pm25_avg.index[-1]
            ax.text(0.02, 0.98, f'ç©ºæ°£æœ€å¥½: {best_county}', transform=ax.transAxes,
                   fontproperties=self.font_prop_large, bbox=dict(boxstyle="round,pad=0.3", facecolor="lightgreen"))
            ax.text(0.02, 0.90, f'ç©ºæ°£æœ€å·®: {worst_county}', transform=ax.transAxes,
                   fontproperties=self.font_prop_large, bbox=dict(boxstyle="round,pad=0.3", facecolor="lightcoral"))
        else:
            ax.text(0.5, 0.5, 'æ­¤åœ–è¡¨åƒ…åœ¨ã€Œå…¨å°å¹³å‡ã€è¦–åœ–ä¸‹é¡¯ç¤º', ha='center', va='center', fontproperties=self.font_prop_text)

    def _plot_enhanced_aqi_pm25_scatter(self, ax, df, title_site):
        """ç¹ªè£½å‡ç´šç‰ˆAQIèˆ‡PM2.5é—œè¯åˆ†æåœ–"""
        ax.set_title('AQI-PM2.5 é—œè¯åˆ†æåœ–', fontproperties=self.font_prop_title)

        if not df.empty and 'pm2.5' in df.columns and 'aqi' in df.columns:
            valid_data = df[df['pm2.5'].notna() & df['aqi'].notna()].copy()

            if len(valid_data) > 10:
                correlation = valid_data['aqi'].corr(valid_data['pm2.5'])

                slope, intercept, r_value, p_value, std_err = stats.linregress(valid_data['pm2.5'], valid_data['aqi'])

                valid_data['aqi_category'] = valid_data['aqi'].apply(self._categorize_aqi)

                ax.axhspan(0, 50, facecolor=self.aqi_colors['è‰¯å¥½'], alpha=0.15, zorder=0)
                ax.axhspan(51, 100, facecolor=self.aqi_colors['æ™®é€š'], alpha=0.15, zorder=0)
                ax.axhspan(101, 150, facecolor=self.aqi_colors['å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·'], alpha=0.15, zorder=0)
                ax.axhspan(151, 200, facecolor=self.aqi_colors['ä¸å¥åº·'], alpha=0.15, zorder=0)
                ax.axhspan(201, 300, facecolor=self.aqi_colors['éå¸¸ä¸å¥åº·'], alpha=0.15, zorder=0)

                for category in self.category_order:
                    category_data = valid_data[valid_data['aqi_category'] == category]
                    if not category_data.empty:
                        ax.scatter(category_data['pm2.5'], category_data['aqi'],
                                 color=self.aqi_colors[category],
                                 label=category, alpha=0.6, s=30,
                                 edgecolors='black', linewidth=0.3, zorder=2)

                x_range = np.linspace(valid_data['pm2.5'].min(), valid_data['pm2.5'].max(), 100)
                regression_line = slope * x_range + intercept
                ax.plot(x_range, regression_line, color='red', linewidth=2,
                       linestyle='--', alpha=0.8, zorder=3, label='å›æ­¸ç·š')

                y_pred = slope * valid_data['pm2.5'] + intercept
                residuals = valid_data['aqi'] - y_pred
                mse = np.mean(residuals**2)
                confidence_interval = 1.96 * np.sqrt(mse)

                ax.fill_between(x_range, regression_line - confidence_interval,
                               regression_line + confidence_interval,
                               alpha=0.2, color='red', zorder=1)

                ax.set_xlabel('PM2.5 æ¿ƒåº¦ (Î¼g/mÂ³)', fontproperties=self.font_prop_large)
                ax.set_ylabel('AQI æŒ‡æ•¸', fontproperties=self.font_prop_large)

                stats_text = f'ç›¸é—œä¿‚æ•¸: {correlation:.3f}\n'
                stats_text += f'å›æ­¸æ–¹ç¨‹å¼: AQI = {slope:.2f} Ã— PM2.5 + {intercept:.1f}\n'
                stats_text += f'RÂ² = {r_value**2:.3f}\n'
                stats_text += f'på€¼ = {p_value:.2e}\n'
                stats_text += f'è³‡æ–™æ•¸: {len(valid_data):,}'

                if abs(correlation) > 0.7:
                    box_color = 'lightgreen'
                elif abs(correlation) > 0.5:
                    box_color = 'lightyellow'
                else:
                    box_color = 'lightcoral'

                ax.text(0.02, 0.98, stats_text, transform=ax.transAxes,
                       fontproperties=self.font_prop, verticalalignment='top',
                       bbox=dict(boxstyle="round,pad=0.5", facecolor=box_color, alpha=0.8))

                ax.legend(prop=self.font_prop, loc='lower right',
                         bbox_to_anchor=(0.98, 0.02), framealpha=0.9)

                ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)

                ax.set_xlim(left=0)
                ax.set_ylim(bottom=0)

            else:
                ax.text(0.5, 0.5, 'è³‡æ–™é»ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œåˆ†æ', ha='center', va='center',
                       fontproperties=self.font_prop_text)
        else:
            ax.text(0.5, 0.5, 'ç„¡æœ‰æ•ˆAQIæˆ–PM2.5è³‡æ–™', ha='center', va='center',
                   fontproperties=self.font_prop_text)

def run_final_project():
    API_KEY = ""
    FALLBACK_KEY = "db5e5f36-b7c0-4f8f-910d-1d7955ce14b1"

    try:
        print("â„¹ï¸ å˜—è©¦å¾ Colab Secrets è®€å–é‡‘é‘° 'MOENV_API_KEY'...")
        API_KEY = userdata.get('MOENV_API_KEY')
        print("ğŸ”‘ æˆåŠŸå¾ Colab Secrets è®€å–é‡‘é‘°ã€‚")
        print(f"ğŸ”‘ ä½¿ç”¨çš„é‡‘é‘°: {API_KEY[:10]}...")
    except (SecretNotFoundError, ImportError):
        print(f"âš ï¸ è­¦å‘Šï¼šæœªåœ¨ Colab Secrets ä¸­æ‰¾åˆ° 'MOENV_API_KEY'ã€‚å°‡ä½¿ç”¨å…§å»ºçš„å‚™ç”¨é‡‘é‘°ã€‚")
        API_KEY = FALLBACK_KEY

    if not API_KEY:
        print("\n" + "ğŸ›‘" * 25)
        print("ğŸ›‘   åŸ·è¡Œå·²åœæ­¢ï¼šç„¡æ³•ç²å–æœ‰æ•ˆçš„APIé‡‘é‘°ã€‚")
        print("ğŸ›‘" * 25)
        print("\nè«‹åœ¨ Colab Secrets ä¸­è¨­å®š 'MOENV_API_KEY'ã€‚")
        return

    START_DATE = "2025-01-01"
    END_DATE = "2025-03-31"

    global zh_font
    FONT_PATH = '/usr/share/fonts/truetype/NotoSansCJKtc-Regular.otf'
    zh_font = FontProperties(fname=FONT_PATH)

    data_handler = DataHandler(API_KEY)
    raw_df = data_handler.fetch_data_for_range(start_date_str=START_DATE, end_date_str=END_DATE)
    df, cleaning_stats = data_handler.clean_data(raw_df)

    if df.empty:
        print("\nâŒ æœªç²å–åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™ï¼Œç„¡æ³•ç¹¼çºŒåŸ·è¡Œã€‚")
        return

    display(Markdown("---"))
    display(Markdown("### åŸå§‹è³‡æ–™é è¦½ (å‰ 5 ç­†)"))
    display(df.head())

    display(Markdown("### åŸå§‹è³‡æ–™åŸºæœ¬è³‡è¨Š"))
    buffer = io.StringIO()
    df.info(buf=buffer)
    print(f"<pre>{buffer.getvalue()}</pre>")

    print("ğŸ”¬ æ­£åœ¨åŸ·è¡Œå¤šç¶­åº¦æ•¸æ“šåˆ†æ...")
    summary_stats = df['aqi'].describe()
    top_10_high = df.groupby(['sitename', 'county'])['aqi'].mean().nlargest(10)
    top_10_low = df.groupby(['sitename', 'county'])['aqi'].mean().nsmallest(10)
    print("âœ… æ•¸æ“šåˆ†æå®Œæˆã€‚")

    display(Markdown("---"))
    display(Markdown("### æ•¸æ“šåˆ†æçµæœ"))

    summary_df = pd.DataFrame(summary_stats)
    summary_df.columns = ['AQI æ•¸å€¼']
    display(Markdown("#### AQI æŒ‡æ•¸çµ±è¨ˆæ‘˜è¦"))
    print(tabulate(summary_df, headers='keys', tablefmt='pipe'))

    top_10_df = top_10_high.reset_index()
    top_10_df['æ¸¬ç«™'] = top_10_df.apply(lambda row: f"{row['sitename']} ({row['county']})", axis=1)
    top_10_df['å¹³å‡ AQI'] = top_10_df['aqi'].round(1)
    display(Markdown("#### AQI å¹³å‡æœ€é«˜å‰ 10 æ¸¬ç«™"))
    print(tabulate(top_10_df[['æ¸¬ç«™', 'å¹³å‡ AQI']], headers='keys', tablefmt='pipe', showindex=False))

    bottom_10_df = top_10_low.reset_index()
    bottom_10_df['æ¸¬ç«™'] = bottom_10_df.apply(lambda row: f"{row['sitename']} ({row['county']})", axis=1)
    bottom_10_df['å¹³å‡ AQI'] = bottom_10_df['aqi'].round(1)
    display(Markdown("#### AQI å¹³å‡æœ€ä½å‰ 10 æ¸¬ç«™"))
    print(tabulate(bottom_10_df[['æ¸¬ç«™', 'å¹³å‡ AQI']], headers='keys', tablefmt='pipe', showindex=False))

    display(Markdown("---"))

    visualizer = AQIVisualizer(df, cleaning_stats, font_path=FONT_PATH)
    visualizer.display_interactive_dashboard()

    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        csv_filename = f"Enhanced_AQI_Analysis_{START_DATE}_to_{END_DATE}_{timestamp}.csv"
        df.to_csv(csv_filename, index=False, encoding='utf-8-sig')
        print(f"\nğŸ’¾ è³‡æ–™å·²å„²å­˜è‡³æª”æ¡ˆï¼š{csv_filename}")
    except Exception as e:
        print(f"\nâŒ å„²å­˜æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

run_final_project()